<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å‰§æœ¬æ€ - æµ‹è¯•æ¨¡å¼</title>
  <style>
    :root {
      --primary: #667eea;
      --secondary: #764ba2;
      --bg: #1a1a2e;
      --card-bg: #16213e;
      --text: #e8e8e8;
      --text-muted: #a0a0a0;
      --border: #2a2a4a;
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, var(--bg) 0%, #0f3460 100%);
      color: var(--text);
      min-height: 100vh;
      padding: 20px;
    }

    h1 {
      text-align: center;
      margin-bottom: 20px;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .controls {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 20px;
      padding: 15px;
      background: var(--card-bg);
      border-radius: 10px;
      border: 1px solid var(--border);
    }

    .controls label {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .controls select, .controls input {
      padding: 8px 12px;
      border-radius: 5px;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text);
      font-size: 14px;
    }

    .controls button {
      padding: 8px 20px;
      border-radius: 5px;
      border: none;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      color: white;
      cursor: pointer;
      font-size: 14px;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .controls button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .phase-selector {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 20px;
    }

    .phase-btn {
      padding: 8px 16px;
      border-radius: 20px;
      border: 1px solid var(--border);
      background: var(--card-bg);
      color: var(--text);
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }

    .phase-btn:hover {
      border-color: var(--primary);
    }

    .phase-btn.active {
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      border-color: transparent;
    }

    .view-toggle {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
    }

    .view-toggle button {
      padding: 8px 20px;
      border-radius: 5px;
      border: 1px solid var(--border);
      background: var(--card-bg);
      color: var(--text);
      cursor: pointer;
    }

    .view-toggle button.active {
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      border-color: transparent;
    }

    /* è§’è‰²å¡ç‰‡ç½‘æ ¼ */
    .characters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .character-card {
      background: var(--card-bg);
      border-radius: 12px;
      border: 1px solid var(--border);
      overflow: hidden;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .character-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    .character-card.culprit {
      border-color: var(--danger);
      box-shadow: 0 0 20px rgba(220, 53, 69, 0.3);
    }

    .character-header {
      padding: 15px;
      background: linear-gradient(90deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .character-header h3 {
      margin: 0;
      font-size: 18px;
    }

    .character-header .badges {
      display: flex;
      gap: 8px;
    }

    .badge {
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
    }

    .badge.culprit {
      background: var(--danger);
      color: white;
    }

    .badge.priority {
      background: var(--primary);
      color: white;
    }

    .character-body {
      padding: 15px;
      max-height: 500px;
      overflow-y: auto;
    }

    .character-body::-webkit-scrollbar {
      width: 6px;
    }

    .character-body::-webkit-scrollbar-track {
      background: var(--bg);
    }

    .character-body::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }

    .section {
      margin-bottom: 15px;
    }

    .section-title {
      font-size: 13px;
      color: var(--primary);
      margin-bottom: 5px;
      font-weight: bold;
    }

    .section-content {
      font-size: 14px;
      line-height: 1.6;
      color: var(--text-muted);
      white-space: pre-wrap;
    }

    .secret-content {
      background: rgba(220, 53, 69, 0.1);
      border-left: 3px solid var(--danger);
      padding: 10px;
      border-radius: 0 5px 5px 0;
    }

    .goal-content {
      background: rgba(40, 167, 69, 0.1);
      border-left: 3px solid var(--success);
      padding: 10px;
      border-radius: 0 5px 5px 0;
    }

    .private-info {
      background: rgba(255, 193, 7, 0.1);
      border-left: 3px solid var(--warning);
      padding: 10px;
      border-radius: 0 5px 5px 0;
      margin-top: 10px;
    }

    .timeline {
      list-style: none;
    }

    .timeline li {
      padding: 5px 0;
      border-left: 2px solid var(--border);
      padding-left: 15px;
      margin-left: 5px;
      position: relative;
    }

    .timeline li::before {
      content: '';
      width: 8px;
      height: 8px;
      background: var(--primary);
      border-radius: 50%;
      position: absolute;
      left: -5px;
      top: 10px;
    }

    .timeline .time {
      color: var(--primary);
      font-weight: bold;
      font-size: 12px;
    }

    .relationships {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 8px;
    }

    .relationship-item {
      background: rgba(102, 126, 234, 0.1);
      padding: 8px;
      border-radius: 5px;
      font-size: 12px;
    }

    .relationship-item strong {
      color: var(--primary);
    }

    /* é˜¶æ®µè§†å›¾ */
    .phase-view {
      background: var(--card-bg);
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 20px;
      margin-bottom: 20px;
    }

    .phase-view h2 {
      margin-bottom: 15px;
      color: var(--primary);
    }

    .event-card {
      background: var(--bg);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      border-left: 3px solid var(--primary);
    }

    .event-card h4 {
      color: var(--primary);
      margin-bottom: 10px;
    }

    .event-timing {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      background: var(--primary);
      color: white;
      margin-left: 10px;
    }

    .event-narrative {
      color: var(--text);
      line-height: 1.6;
      margin-bottom: 10px;
    }

    .private-info-list {
      margin-top: 10px;
    }

    .private-info-item {
      background: rgba(255, 193, 7, 0.1);
      border-left: 3px solid var(--warning);
      padding: 8px 12px;
      margin: 5px 0;
      border-radius: 0 5px 5px 0;
      font-size: 13px;
    }

    .private-info-item strong {
      color: var(--warning);
    }

    /* çº¿ç´¢è§†å›¾ */
    .clues-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
    }

    .clue-card {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 15px;
      border: 1px solid var(--border);
    }

    .clue-card h4 {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    .clue-card .icon {
      font-size: 20px;
    }

    .clue-type {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      background: var(--secondary);
      color: white;
      margin-left: auto;
    }

    .clue-phase {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 8px;
    }

    /* åŠ è½½çŠ¶æ€ */
    .loading {
      text-align: center;
      padding: 50px;
      color: var(--text-muted);
    }

    .loading::after {
      content: '';
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--primary);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* å“åº”å¼ */
    @media (max-width: 768px) {
      .characters-grid {
        grid-template-columns: 1fr;
      }
      
      .controls {
        flex-direction: column;
        align-items: stretch;
      }
    }
  </style>
</head>
<body>
  <h1>ğŸ­ å‰§æœ¬æ€æµ‹è¯•æ¨¡å¼</h1>
  
  <div class="controls">
    <label>
      å‰§æœ¬ï¼š
      <select id="scriptSelect">
        <option value="">åŠ è½½ä¸­...</option>
      </select>
    </label>
    <label>
      ç©å®¶äººæ•°ï¼š
      <input type="number" id="playerCount" min="4" max="10" value="6">
    </label>
    <button onclick="loadScript()">åŠ è½½å‰§æœ¬</button>
  </div>

  <div class="view-toggle">
    <button id="viewCharacters" class="active" onclick="switchView('characters')">è§’è‰²è§†å›¾</button>
    <button id="viewPhases" onclick="switchView('phases')">é˜¶æ®µè§†å›¾</button>
    <button id="viewClues" onclick="switchView('clues')">çº¿ç´¢è§†å›¾</button>
    <button id="viewAll" onclick="switchView('all')">å®Œæ•´è§†å›¾</button>
  </div>

  <div id="phaseSelector" class="phase-selector" style="display: none;"></div>

  <div id="content">
    <div class="loading">æ­£åœ¨è¿æ¥æœåŠ¡å™¨...</div>
  </div>

  <script>
    let ws = null;
    let currentScript = null;
    let currentView = 'characters';
    let currentPhase = null;
    let scripts = [];

    // ä» URL å‚æ•°è¯»å–ç«¯å£é…ç½®
    const urlParams = new URLSearchParams(window.location.search);
    const PORT = urlParams.get('port') || '4000';

    function connect() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const host = window.location.host;
      const wsUrl = `${protocol}//${host}/ws`;
      
      console.log('Connecting to:', wsUrl);
      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        console.log('Connected');
        loadScriptList();
      };

      ws.onmessage = (event) => {
        const message = JSON.parse(event.data);
        handleMessage(message);
      };

      ws.onerror = (error) => {
        console.error('WebSocket error:', error);
        document.getElementById('content').innerHTML = '<div class="loading">è¿æ¥å¤±è´¥ï¼Œè¯·ç¡®ä¿æœåŠ¡å™¨å·²å¯åŠ¨</div>';
      };

      ws.onclose = () => {
        console.log('Disconnected');
        setTimeout(connect, 3000);
      };
    }

    function sendMessage(event, data) {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify({ id: Date.now().toString(), event, data }));
    }

    function handleMessage(message) {
      if (message.data?.scripts) {
        scripts = message.data.scripts;
        updateScriptSelect();
      } else if (message.data?.script) {
        currentScript = message.data.script;
        renderContent();
      }
    }

    function loadScriptList() {
      sendMessage('script:list', {});
    }

    function updateScriptSelect() {
      const select = document.getElementById('scriptSelect');
      select.innerHTML = scripts.map(s => 
        `<option value="${s.id}">${s.title} (${s.minPlayers}-${s.maxPlayers}äºº)</option>`
      ).join('');
      
      // è‡ªåŠ¨åŠ è½½ç¬¬ä¸€ä¸ªå‰§æœ¬
      if (scripts.length > 0) {
        loadScript();
      }
    }

    function loadScript() {
      const scriptId = document.getElementById('scriptSelect').value;
      if (!scriptId) return;
      
      document.getElementById('content').innerHTML = '<div class="loading">åŠ è½½å‰§æœ¬ä¸­...</div>';
      sendMessage('script:get', { scriptId });
    }

    function switchView(view) {
      currentView = view;
      
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('.view-toggle button').forEach(btn => btn.classList.remove('active'));
      document.getElementById('view' + view.charAt(0).toUpperCase() + view.slice(1)).classList.add('active');
      
      // æ˜¾ç¤º/éšè—é˜¶æ®µé€‰æ‹©å™¨
      document.getElementById('phaseSelector').style.display = 
        (view === 'phases' || view === 'all') ? 'flex' : 'none';
      
      renderContent();
    }

    function selectPhase(phaseId) {
      currentPhase = phaseId;
      document.querySelectorAll('.phase-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.phase === phaseId);
      });
      renderContent();
    }

    function renderContent() {
      if (!currentScript) return;
      
      const content = document.getElementById('content');
      const playerCount = parseInt(document.getElementById('playerCount').value) || 6;
      
      // æ›´æ–°é˜¶æ®µé€‰æ‹©å™¨
      if (currentScript.phases) {
        const phaseSelector = document.getElementById('phaseSelector');
        phaseSelector.innerHTML = currentScript.phases.map((p, i) => 
          `<button class="phase-btn ${currentPhase === p.id || (!currentPhase && i === 0) ? 'active' : ''}" 
                   data-phase="${p.id}" onclick="selectPhase('${p.id}')">${p.name}</button>`
        ).join('');
        
        if (!currentPhase && currentScript.phases.length > 0) {
          currentPhase = currentScript.phases[0].id;
        }
      }
      
      let html = '';
      
      switch (currentView) {
        case 'characters':
          html = renderCharactersView(playerCount);
          break;
        case 'phases':
          html = renderPhasesView();
          break;
        case 'clues':
          html = renderCluesView();
          break;
        case 'all':
          html = renderAllView(playerCount);
          break;
      }
      
      content.innerHTML = html;
    }

    function getActiveCharacters(playerCount) {
      if (!currentScript.characterConfig) {
        return currentScript.characters.slice(0, playerCount);
      }
      
      const { required, optional } = currentScript.characterConfig;
      const activeIds = [...required];
      
      if (optional) {
        for (const opt of optional) {
          if (playerCount >= opt.minPlayers) {
            activeIds.push(opt.characterId);
          }
        }
      }
      
      return currentScript.characters.filter(c => activeIds.includes(c.id));
    }

    function renderCharactersView(playerCount) {
      const characters = getActiveCharacters(playerCount);
      const culpritId = currentScript.culpritId;
      
      return `
        <div class="characters-grid">
          ${characters.map(char => renderCharacterCard(char, culpritId)).join('')}
        </div>
      `;
    }

    function renderCharacterCard(char, culpritId) {
      const isCulprit = char.id === culpritId;
      
      // è·å–å½“å‰é˜¶æ®µçš„ç§å¯†ä¿¡æ¯
      let privateInfo = '';
      if (currentPhase && currentScript.phases) {
        const phase = currentScript.phases.find(p => p.id === currentPhase);
        if (phase && phase.events) {
          const charPrivateInfos = phase.events
            .filter(e => e.privateInfo && e.privateInfo[char.id])
            .map(e => `<div class="private-info"><strong>ã€${e.title}ã€‘</strong> ${e.privateInfo[char.id]}</div>`)
            .join('');
          if (charPrivateInfos) {
            privateInfo = `
              <div class="section">
                <div class="section-title">ğŸ“ æœ¬é˜¶æ®µç§å¯†ä¿¡æ¯</div>
                ${charPrivateInfos}
              </div>
            `;
          }
        }
      }
      
      return `
        <div class="character-card ${isCulprit ? 'culprit' : ''}">
          <div class="character-header">
            <h3>${char.name} - ${char.title}</h3>
            <div class="badges">
              ${isCulprit ? '<span class="badge culprit">çœŸå‡¶</span>' : ''}
              ${char.priority ? `<span class="badge priority">ä¼˜å…ˆçº§ ${char.priority}</span>` : ''}
            </div>
          </div>
          <div class="character-body">
            <div class="section">
              <div class="section-title">ğŸ“– æè¿°</div>
              <div class="section-content">${char.description}</div>
            </div>
            
            <div class="section">
              <div class="section-title">ğŸ“œ èƒŒæ™¯æ•…äº‹</div>
              <div class="section-content">${char.background}</div>
            </div>
            
            ${char.secret ? `
              <div class="section">
                <div class="section-title">ğŸ”’ ç§˜å¯†</div>
                <div class="section-content secret-content">${char.secret}</div>
              </div>
            ` : ''}
            
            <div class="section">
              <div class="section-title">ğŸ¯ ç›®æ ‡</div>
              <div class="section-content goal-content">${char.goal}</div>
            </div>
            
            ${privateInfo}
            
            ${char.timeline && char.timeline.length > 0 ? `
              <div class="section">
                <div class="section-title">â° æ—¶é—´çº¿</div>
                <ul class="timeline">
                  ${char.timeline.map(t => `
                    <li>
                      <span class="time">${t.time}</span><br>
                      ${t.event}
                    </li>
                  `).join('')}
                </ul>
              </div>
            ` : ''}
            
            ${char.relationships ? `
              <div class="section">
                <div class="section-title">ğŸ‘¥ äººç‰©å…³ç³»</div>
                <div class="relationships">
                  ${Object.entries(char.relationships).map(([id, rel]) => `
                    <div class="relationship-item">
                      <strong>${id}</strong>: ${rel}
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}
            
            ${char.skills && char.skills.length > 0 ? `
              <div class="section">
                <div class="section-title">âœ¨ æŠ€èƒ½</div>
                <div class="section-content">${char.skills.join('ã€')}</div>
              </div>
            ` : ''}
            
            ${char.alibis && char.alibis.length > 0 ? `
              <div class="section">
                <div class="section-title">ğŸ›¡ï¸ ä¸åœ¨åœºè¯æ˜</div>
                <ul>
                  ${char.alibis.map(a => `<li>${a}</li>`).join('')}
                </ul>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }

    function renderPhasesView() {
      if (!currentScript.phases) return '<p>è¯¥å‰§æœ¬æ²¡æœ‰å®šä¹‰é˜¶æ®µ</p>';
      
      const phase = currentScript.phases.find(p => p.id === currentPhase);
      if (!phase) return '<p>è¯·é€‰æ‹©ä¸€ä¸ªé˜¶æ®µ</p>';
      
      return `
        <div class="phase-view">
          <h2>${phase.name}</h2>
          <p><strong>æè¿°ï¼š</strong>${phase.description}</p>
          ${phase.duration ? `<p><strong>é¢„è®¡æ—¶é•¿ï¼š</strong>${phase.duration} åˆ†é’Ÿ</p>` : ''}
          ${phase.narrative ? `<p><strong>å™äº‹ï¼š</strong>${phase.narrative}</p>` : ''}
          ${phase.tips ? `<p><strong>æç¤ºï¼š</strong>${phase.tips}</p>` : ''}
          
          ${phase.events && phase.events.length > 0 ? `
            <h3 style="margin-top: 20px; margin-bottom: 15px;">ğŸ“– å‰§æƒ…äº‹ä»¶</h3>
            ${phase.events.map(event => `
              <div class="event-card">
                <h4>${event.title} <span class="event-timing">${event.timing}</span></h4>
                <div class="event-narrative">${event.narrative}</div>
                ${event.privateInfo ? `
                  <div class="private-info-list">
                    <strong>ç§å¯†ä¿¡æ¯ï¼š</strong>
                    ${Object.entries(event.privateInfo).map(([charId, info]) => `
                      <div class="private-info-item">
                        <strong>${charId}ï¼š</strong>${info}
                      </div>
                    `).join('')}
                  </div>
                ` : ''}
                ${event.revealsClues && event.revealsClues.length > 0 ? `
                  <p style="margin-top: 10px; color: var(--success);">
                    <strong>æ­ç¤ºçº¿ç´¢ï¼š</strong>${event.revealsClues.join('ã€')}
                  </p>
                ` : ''}
              </div>
            `).join('')}
          ` : ''}
          
          ${phase.characterActions && phase.characterActions.length > 0 ? `
            <h3 style="margin-top: 20px; margin-bottom: 15px;">ğŸ¬ å¯æ‰§è¡Œè¡ŒåŠ¨</h3>
            ${phase.characterActions.map(action => `
              <div class="event-card">
                <h4>${action.name}</h4>
                <p>${action.description}</p>
                <p><strong>å¯ç”¨è§’è‰²ï¼š</strong>${Array.isArray(action.availableTo) ? action.availableTo.join('ã€') : action.availableTo}</p>
                ${action.condition ? `<p><strong>æ¡ä»¶ï¼š</strong>${action.condition}</p>` : ''}
              </div>
            `).join('')}
          ` : ''}
          
          ${phase.cluesRevealed && phase.cluesRevealed.length > 0 ? `
            <h3 style="margin-top: 20px; margin-bottom: 15px;">ğŸ” æœ¬é˜¶æ®µæ­ç¤ºçš„çº¿ç´¢</h3>
            <p>${phase.cluesRevealed.join('ã€')}</p>
          ` : ''}
        </div>
      `;
    }

    function renderCluesView() {
      if (!currentScript.clues) return '<p>è¯¥å‰§æœ¬æ²¡æœ‰å®šä¹‰çº¿ç´¢</p>';
      
      return `
        <div class="clues-grid">
          ${currentScript.clues.map(clue => `
            <div class="clue-card">
              <h4>
                <span class="icon">${clue.icon || 'ğŸ“„'}</span>
                ${clue.name}
                <span class="clue-type">${clue.type}</span>
              </h4>
              <p>${clue.description}</p>
              ${clue.content ? `<p style="margin-top: 10px; color: var(--text);">${clue.content}</p>` : ''}
              ${clue.owner ? `<p class="clue-phase"><strong>æŒæœ‰è€…ï¼š</strong>${clue.owner}</p>` : ''}
              ${clue.revealPhase ? `<p class="clue-phase"><strong>æ­ç¤ºé˜¶æ®µï¼š</strong>${clue.revealPhase}</p>` : ''}
              ${clue.condition ? `<p class="clue-phase"><strong>è·å–æ¡ä»¶ï¼š</strong>${clue.condition}</p>` : ''}
              ${clue.reliability ? `<p class="clue-phase" style="color: var(--warning);"><strong>å¯ä¿¡åº¦ï¼š</strong>${clue.reliability}</p>` : ''}
            </div>
          `).join('')}
        </div>
      `;
    }

    function renderAllView(playerCount) {
      return `
        <h2 style="margin-bottom: 20px;">ğŸ“– å‰§æœ¬æ¦‚è§ˆ</h2>
        <div class="phase-view" style="margin-bottom: 30px;">
          <h3>åŸºæœ¬ä¿¡æ¯</h3>
          <p><strong>æ ‡é¢˜ï¼š</strong>${currentScript.title}</p>
          <p><strong>æè¿°ï¼š</strong>${currentScript.description}</p>
          <p><strong>äººæ•°ï¼š</strong>${currentScript.minPlayers}-${currentScript.maxPlayers}äºº</p>
          <p><strong>æ—¶é•¿ï¼š</strong>${currentScript.estimatedTime}åˆ†é’Ÿ</p>
          <p><strong>éš¾åº¦ï¼š</strong>${currentScript.difficulty}</p>
          ${currentScript.culpritId ? `<p><strong>çœŸå‡¶ï¼š</strong>${currentScript.culpritId}</p>` : ''}
        </div>
        
        ${currentScript.storyline && currentScript.storyline.length > 0 ? `
          <div class="phase-view" style="margin-bottom: 30px;">
            <h3>ğŸ“œ æ•…äº‹çº¿</h3>
            <ol>
              ${currentScript.storyline.map(s => `<li style="margin: 8px 0;">${s}</li>`).join('')}
            </ol>
          </div>
        ` : ''}
        
        <h2 style="margin: 30px 0 20px;">ğŸ­ è§’è‰²åˆ—è¡¨ (${playerCount}äºº)</h2>
        ${renderCharactersView(playerCount)}
        
        <h2 style="margin: 30px 0 20px;">ğŸ“‹ é˜¶æ®µæµç¨‹</h2>
        ${currentScript.phases ? currentScript.phases.map(phase => `
          <div class="phase-view" style="margin-bottom: 15px;">
            <h3>${phase.name}</h3>
            <p>${phase.description}</p>
            ${phase.duration ? `<p><em>æ—¶é•¿ï¼š${phase.duration}åˆ†é’Ÿ</em></p>` : ''}
          </div>
        `).join('') : '<p>æ— é˜¶æ®µå®šä¹‰</p>'}
        
        <h2 style="margin: 30px 0 20px;">ğŸ” çº¿ç´¢åˆ—è¡¨</h2>
        ${renderCluesView()}
        
        ${currentScript.suspicionMatrix ? `
          <h2 style="margin: 30px 0 20px;">ğŸ“Š å«Œç–‘çŸ©é˜µ</h2>
          <div class="phase-view">
            ${Object.entries(currentScript.suspicionMatrix).map(([charId, data]) => `
              <div style="margin-bottom: 15px; padding: 10px; background: var(--bg); border-radius: 8px;">
                <h4 style="color: ${data.level === 'high' ? 'var(--danger)' : data.level === 'medium' ? 'var(--warning)' : 'var(--text-muted)'};">
                  ${charId} - å«Œç–‘ç­‰çº§: ${data.level}
                </h4>
                ${data.evidence && data.evidence.length > 0 ? `
                  <p><strong>å¯ç–‘è¯æ®ï¼š</strong>${data.evidence.join('ã€')}</p>
                ` : ''}
                ${data.counterEvidence && data.counterEvidence.length > 0 ? `
                  <p><strong>åè¯ï¼š</strong>${data.counterEvidence.join('ã€')}</p>
                ` : ''}
              </div>
            `).join('')}
          </div>
        ` : ''}
      `;
    }

    // åˆå§‹åŒ–
    connect();
  </script>
</body>
</html>
